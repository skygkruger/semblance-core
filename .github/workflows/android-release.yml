name: Android Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  build-android:
    name: Build & Upload to Play Store
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/mobile

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Setup Android SDK + NDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: sdkmanager "ndk;27.1.12297006"

      - run: pnpm install --frozen-lockfile
        working-directory: .

      # Decode signing keystore
      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
        run: |
          echo "$ANDROID_KEYSTORE" | base64 --decode > android/app/release.keystore
          cat > android/keystore.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      # Update version
      - name: Set Version
        run: |
          sed -i "s/versionName \".*\"/versionName \"${{ inputs.version }}\"/" android/app/build.gradle
          sed -i "s/versionCode [0-9]*/versionCode ${{ github.run_number }}/" android/app/build.gradle

      # Build release AAB (Android App Bundle)
      - name: Build Release AAB
        run: cd android && ./gradlew bundleRelease

      # Upload to Play Store internal track
      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: run.semblance.app
          releaseFiles: packages/mobile/android/app/build/outputs/bundle/release/app-release.aab
          track: internal
          status: draft

      # Cleanup secrets
      - name: Cleanup
        if: always()
        run: |
          rm -f android/app/release.keystore
          rm -f android/keystore.properties
